---
- name: Apply iptables rules
  hosts: firewall_servers
  become: yes
  gather_facts: yes # facts ìˆ˜ì§‘ ìœ ì§€ (OS ì •ë³´ í™œìš©)

  vars:
    # ----------------------------------------------------
    # ê¸°ë³¸ ì •ì±… ì„¤ì •ì„ ìœ„í•œ ë³€ìˆ˜ (default_policyì—ì„œ ì˜¤ë²„ë¼ì´ë“œ ê°€ëŠ¥)
    # ----------------------------------------------------
    default_input_policy: "{{ default_policy.input | default('DROP') | upper }}"
    default_forward_policy: "{{ default_policy.forward | default('DROP') | upper }}"
    default_output_policy: "{{ default_policy.output | default('ACCEPT') | upper }}"
    
    # ----------------------------------------------------
    # ê¸°íƒ€ ë³€ìˆ˜
    # ----------------------------------------------------
    persist_rules_path: /etc/iptables/rules.v4
    
    # APIë¡œë¶€í„° ì „ë‹¬ë°›ëŠ” ê·œì¹™ì„ ìœ„í•œ ë³€ìˆ˜ (ê¸°ë³¸ê°’ ë¹ˆ ë¦¬ìŠ¤íŠ¸)
    rules_from_api: "{{ rules_from_api | default([]) }}" 

  pre_tasks:
    - name: Ensure iptables tools are present (Debian/Ubuntu)
      apt:
        name:
          - iptables
          - iptables-persistent
          - netfilter-persistent
        state: present
        update_cache: yes
      when: ansible_os_family == 'Debian'

    - name: Flush existing rules in INPUT, FORWARD, OUTPUT chains
      iptables:
        flush: yes
        chain: "{{ item }}"
        table: filter # ëª…ì‹œì ìœ¼ë¡œ filter í…Œì´ë¸” ì§€ì • (ê¸°ë³¸ê°’)
      loop:
        - INPUT
        - FORWARD
        - OUTPUT

    # ğŸ”’ ë½ì•„ì›ƒ ë°©ì§€: SSH í—ˆìš© ë¨¼ì € ê¹”ì•„ë‘ê¸°
    # Flush ì§í›„ ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ì–´ SSH ì—°ê²°ì„ ë³´í˜¸í•©ë‹ˆë‹¤.
    - name: Ensure SSH is open (lockout protection)
      iptables:
        chain: INPUT
        protocol: tcp
        destination_port: 22
        jump: ACCEPT
        comment: "Bootstrap: Allow SSH for Ansible control"

  tasks:
    # ============================================
    # 1. ê¸°ë³¸ ì •ì±… ì„¤ì •
    # ============================================
    - name: Set default policies for INPUT, FORWARD, OUTPUT chains
      iptables:
        chain: "{{ item.chain }}"
        policy: "{{ item.policy }}"
      loop:
        - { chain: 'INPUT',   policy: '{{ default_input_policy }}' }
        - { chain: 'FORWARD', policy: '{{ default_forward_policy }}' }
        - { chain: 'OUTPUT',  policy: '{{ default_output_policy }}' }

    # ============================================
    # 2. í•„ìˆ˜ ê¸°ë³¸ ê·œì¹™ (ì–´ë–¤ ìƒí™©ì—ì„œë„ ìœ ì§€ë˜ì–´ì•¼ í•  ê·œì¹™)
    # ============================================
    - name: Allow established and related connections
      iptables:
        chain: INPUT
        ctstate: ESTABLISHED,RELATED
        jump: ACCEPT
        comment: "Allow established/related connections"

    - name: Allow loopback traffic on INPUT chain
      iptables:
        chain: INPUT
        in_interface: lo
        jump: ACCEPT
        comment: "Allow loopback traffic"

    # ============================================
    # 3. APIë¥¼ í†µí•´ ì „ë‹¬ëœ ë™ì  ê·œì¹™ ì ìš©
    # ============================================
    - name: Apply dynamic rules from API (INPUT chain only, as per original)
      # ì›ë˜ í”Œë ˆì´ë¶ì—ì„œ rules_from_apië¥¼ INPUT chainì—ë§Œ ì ìš©í–ˆìœ¼ë¯€ë¡œ, 
      # í•´ë‹¹ ë™ì‘ì„ ìœ ì§€í•©ë‹ˆë‹¤. ë‹¤ë¥¸ chainì— ì ìš©í•˜ë ¤ë©´ item.chainì„ í™œìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      iptables:
        chain: INPUT 
        protocol: "{{ item.protocol | default(omit) }}"
        destination_port: "{{ (item.port is defined) | ternary(item.port, omit) }}"
        source: "{{ item.source_ip | default(omit) }}"
        jump: "{{ item.action | default('ACCEPT') | upper }}"
        comment: "{{ item.comment | default('Dynamic rule from API') }}"
      loop: "{{ rules_from_api }}"
      when: rules_from_api is defined and rules_from_api | length > 0

    # ============================================
    # 4. ëª¨ë“  ê·œì¹™ ì ìš© í›„ ì •ì±… ì €ì¥
    # ============================================
    - name: Persist rules to file (Debian/Ubuntu)
      shell: iptables-save > {{ persist_rules_path }}
      notify: Restart netfilter-persistent
      when: ansible_os_family == 'Debian'

  handlers:
    - name: Restart netfilter-persistent
      systemd:
        name: netfilter-persistent
        state: restarted
        enabled: yes