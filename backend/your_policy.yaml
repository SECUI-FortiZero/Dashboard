mode: merge
rules:
  # 1. 온프레미스 방화벽 -> Bastion Host (Public IP)
  - platform: on-premise
    chain: FORWARD
    protocol: tcp
    destination_ip: "3.37.200.119"      # Bastion Host의 공인 IP
    port: 22
    source_ip: "192.168.5.40/32"        # 사용자 PC의 내부 IP
    action: ACCEPT
    comment: "Allow internal user to access Bastion"

  # 2. 외부 -> Bastion Host 보안 그룹
  - platform: aws
    target_sg: "BastionServerSG"
    protocol: tcp
    port: 22
    source_ip: "211.211.211.211/32"     # 온프레미스 방화벽의 공인 IP
    action: allow
    comment: "Allow SSH from On-premise Office"

  # 3. Bastion Host -> FTP 서버 보안 그룹
  - platform: aws
    target_sg: "FTPServerSG"
    protocol: tcp
    port: 21
    source_sg: "BastionServerSG"
    action: allow
    comment: "Allow FTP Control from Bastion"
  - platform: aws
    target_sg: "FTPServerSG"
    protocol: tcp
    port: "50000-50009"
    source_sg: "BastionServerSG"
    action: allow
    comment: "Allow FTP Passive Data from Bastion"

  # (신규) IAM 사용자 생성
  - platform: aws
    type: iam_user
    name: new_intern_user
    path: / # 패치를 할 때 최상위로
    tags:
      owner: soobin
      env: dev
    managed_policies:
      - arn:aws:iam::aws:policy/ReadOnlyAccess
    inline_policies:
      - name: AllowStartStopEC2
        document:
          Version: "2012-10-17"
          Statement:
            - Effect: Allow
              Action: ["ec2:StartInstances","ec2:StopInstances"]
              Resource: "*"
    # 아래 옵션은 필요할 때만 켜세요 (기본값 false)
    create_login_profile: false         # true면 콘솔 로그인 프로필 생성
    login_password: null                # 미지정시 AWS가 생성(보통 PGP 요구). 안전상 기본 null
    password_reset_required: true
    create_access_key: false            # true면 액세스키 생성(비밀키는 Terraform이 민감 처리)
    pgp_key: null                       # keybase:아이디 또는 PGP 공개키 (비밀키 암호화용 권장)
    permissions_boundary: null          # 선택: Permission Boundary ARN
    force_destroy: false                # true면 삭제 시 액세스키/로그인프로필 함께 삭제
